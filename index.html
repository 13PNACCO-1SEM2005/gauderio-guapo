<html>
<head>
	<script src="phaser.min.js"></script>
	<script src="Queue.js"></script>
	<script>
		var game = new Phaser.Game(400, 300, Phaser.CANVAS, 'gameCanvas', {preload: preload, create: create, update: update});
		var player;
		var background;
		var ACCELERATION = 10;
		var MAX_SPEED = 300;
		var ground = new Array(9);
		var upAheadQueue = new Queue();
		var andar = {
   			"frames": [
				{
    				"frame": { "x": 4, "y": 1, "w": 93, "h": 154 }
				},
				{
				    "frame": { "x": 105, "y": 1, "w": 93, "h": 154}
				},
				{
				    "frame": { "x": 205, "y": 1, "w": 93, "h": 154}
				},
				{
				    "frame": { "x": 305, "y": 1, "w": 93, "h": 154}
				}
			]	
		};



		function preload(){
			game.load.image('fundo','fundo.png');
			game.load.image('rua','rua.png');
			
			game.load.atlas('player', 'char-johannes.png', Phaser.Loader.TEXTURE_ATLAS_JSON_ARRAY, andar);
		}

		function create(){
			game.input.keyboard.addKeyCapture([Phaser.Keyboard.LEFT, Phaser.Keyboard.RIGHT]);

			game.world.setBounds(0, 0, 0xFFFFFFFF, 300);
			game.physics.arcade.gravity.y = 999990;

			background = game.add.sprite(0,0,'fundo');
			//game.physics.enable(background, Phaser.Physics.ARCADE);
			//background.body.maxVelocity.setTo(2, 5);
			//background.body.allowGravity = false;

			player = game.add.sprite(-30,198,'player');
			player.scale.setTo(0.5,0.5);
			player.animations.add('run');
			player.animations.play('run', 8, true);
			game.physics.enable(player, Phaser.Physics.ARCADE);
			player.body.collideWorldBounds = false;
			player.body.maxVelocity.setTo(MAX_SPEED, MAX_SPEED/2);
			player.body.velocity.x = 100;

			for(var x = 0; x < ground.length; x++){
				ground[x] = game.add.sprite(x*205, game.height - 25, 'rua' );
				game.physics.enable(ground[x], Phaser.Physics.ARCADE);
				ground[x].body.allowGravity = false;
				ground[x].body.immovable = true;
			}

			for(var x = 0; x < ground.length; x++) upAheadQueue.enqueue(ground[x]);
			game.camera.follow(player);
			game.camera.deadzone = new Phaser.Rectangle(0,32,25,200);
		}
		
		function update(){
			
			for(var x = 0; x < ground.length; x++){
				game.physics.arcade.collide(player, ground[x]);
				//ground[x].body.acceleration.x = -ACCELERATION;
				if(!upAheadQueue.peek().inCamera){
					var aux = upAheadQueue.dequeue();
					aux.x = aux.x+(205*8)
					upAheadQueue.enqueue(aux);
					delete aux;
				}
			}
			if(leftInputIsActive()){
				player.body.velocity.y = -80099;
			}
			player.body.acceleration.x = ACCELERATION;
			//background.body.acceleration.x = 1;
		}
		
		function leftInputIsActive(){
			var isActive = false;

			isActive = game.input.keyboard.isDown(Phaser.Keyboard.LEFT);
			isActive |= (game.input.activePointer.isDown &&
			game.input.activePointer.x < game.width/4);

			return isActive;
		}
		
		function rightInputIsActive() {
			var isActive = false;

			isActive = game.input.keyboard.isDown(Phaser.Keyboard.RIGHT);
			isActive |= (game.input.activePointer.isDown &&
			game.input.activePointer.x > game.width/2 + game.width/4);

			return isActive;
		};

		
	</script>
</head>
<body>
<div id="gameCanvas"></div>
</body>
</html>