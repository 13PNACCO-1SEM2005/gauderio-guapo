<html>
<head>
	<script src="phaser.min.js"></script>
	<script src="Queue.js"></script>
	<script>
		var game = new Phaser.Game(400, 300, Phaser.CANVAS, 'gameCanvas', {preload: preload, create: create, update: update});
		var player;
		var ACCELERATION = 50;
		var MAX_SPEED = 100; 
		var ground = new Array(9);
		var upAheadQueue = new Queue;
		var mix = new Array();
		var andar = {
   			"frames": [
				{
    				"frame": { "x": 4, "y": 1, "w": 93, "h": 154 }
				},
				{
				    "frame": { "x": 105, "y": 1, "w": 93, "h": 154}
				},
				{
				    "frame": { "x": 205, "y": 1, "w": 93, "h": 154}
				},
				{
				    "frame": { "x": 305, "y": 1, "w": 93, "h": 154}
				}
			]	
		};



		function preload(){
			game.load.image('ground','ground.png');
			game.load.image('ground-land','ground-land.png');
			game.stage.backgroundColor = 0x4488cc;
			game.load.atlas('player', 'char-johannes.png', Phaser.Loader.TEXTURE_ATLAS_JSON_ARRAY, andar);
		}

		function create(){
			player = game.add.sprite(0,180,'player');
			player.scale.setTo(0.5,0.5);
			player.animations.add('run');
			player.animations.play('run', 8, true);
			game.world.setBounds(0, 0, 900, 300);
			
			game.input.keyboard.addKeyCapture([Phaser.Keyboard.LEFT, Phaser.Keyboard.RIGHT]);
			game.physics.enable(player, Phaser.Physics.ARCADE);
			player.body.collideWorldBounds = false;
			player.body.maxVelocity.setTo(this.MAX_SPEED, this.MAX_SPEED/3);
			game.physics.arcade.gravity.y = 900;
			for(var x = 0; x < ground.length; x++){
				ground[x] = game.add.sprite(x*300, game.height - 32, (Math.random() >= 0.48) ? 'ground' : 'ground-land');
				game.physics.enable(ground[x], Phaser.Physics.ARCADE);
				ground[x].body.allowGravity = false;
				ground[x].body.maxVelocity.setTo(this.MAX_SPEED, 0);
				ground[x].body.immovable = true;
			}
			for(var x = 0; x < ground.length; x++) upAheadQueue.enqueue(ground[x]);
			game.camera.follow(player);
			game.camera.deadzone = new Phaser.Rectangle(0,32,25,200);
		}
		
		function update(){
			
			for(var x = 0; x < ground.length; x++){
				game.physics.arcade.collide(player, ground[x]);
				ground[x].body.acceleration.x = -ACCELERATION;
				if(!upAheadQueue.peek().inCamera && mix.length < 4 ) mix.push(upAheadQueue.dequeue());
				if(upAheadQueue.getLength() <= 5 && ground[x].inCamera && ground[x].x > 1){
					// console.log(upAheadQueue.getLength());
					// console.log(ground[x].x);
					// game.enableStep();
					mix[2].x = ground[x].x*8;
					mix[1].x = ground[x].x*7;
					mix[3].x = ground[x].x*6;
					mix[0].x = ground[x].x*5;
					upAheadQueue.enqueue(mix[0]);
					upAheadQueue.enqueue(mix[3]);
					upAheadQueue.enqueue(mix[1]);
					upAheadQueue.enqueue(mix[2]);
					mix = [];
				}
			}
			player.body.acceleration.x = ACCELERATION;
			
		}
		
		function leftInputIsActive(){
			var isActive = false;

			isActive = game.input.keyboard.isDown(Phaser.Keyboard.LEFT);
			isActive |= (game.input.activePointer.isDown &&
			game.input.activePointer.x < game.width/4);

			return isActive;
		}
		
		function rightInputIsActive() {
			var isActive = false;

			isActive = game.input.keyboard.isDown(Phaser.Keyboard.RIGHT);
			isActive |= (game.input.activePointer.isDown &&
			game.input.activePointer.x > game.width/2 + game.width/4);

			return isActive;
		};

		
	</script>
</head>
<body>
<div id="gameCanvas"></div>
</body>
</html>