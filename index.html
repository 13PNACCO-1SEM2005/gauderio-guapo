<html>
<head>
	<script src="phaser.min.js"></script>
	<script src="Queue.js"></script>
	<script>
		var game = new Phaser.Game(400, 300, Phaser.CANVAS, 'gameCanvas', {preload: preload, create: create, update: update});
		var player;
		var background = new Array(9);
		var ACCELERATION = 10;
		var MAX_SPEED = 400;
		var ground = new Array(9);
		var upAheadQueue = new Queue();
		var upAheadQueueBackground = new Queue();
		var style = {
			font: "28px Arial",
			fill: "#F0EC1A",
			stroke: "black",
			strokeThickness: 3
		};
		var pontos;
		var churras;
		var voice;
		var andar = {
   			"frames": [
				{
    				"frame": { "x": 4, "y": 1, "w": 93, "h": 154 }
				},
				{
				    "frame": { "x": 105, "y": 1, "w": 93, "h": 154}
				},
				{
				    "frame": { "x": 205, "y": 1, "w": 93, "h": 154}
				},
				{
				    "frame": { "x": 305, "y": 1, "w": 93, "h": 154}
				}
			]	
		};



		function preload(){
			game.load.image('fundo','fundo_transparente.png');
			game.load.image('rua','rua.png');
			game.load.image('chima','itens-chimas.png');
			game.load.audio('churras-voice','voice-churras-1.wav');
			game.load.atlas('player', 'char-johannes.png', Phaser.Loader.TEXTURE_ATLAS_JSON_ARRAY, andar);
		}

		function create(){
			game.input.keyboard.addKeyCapture([Phaser.Keyboard.LEFT, Phaser.Keyboard.UP]);

			game.world.setBounds(0, 0, 0xFFFFFFFF, 300);
			game.physics.arcade.gravity.y = 500;
			game.stage.backgroundColor = '#87CEEB'

			for(var x = 0; x < background.length; x++){
				background[x] = game.add.sprite(x*622,0,'fundo');
			}
			//game.physics.enable(background, Phaser.Physics.ARCADE);
			//background.body.maxVelocity.setTo(2, 5);
			//background.body.allowGravity = false;

			player = game.add.sprite(-30,198,'player');
			player.scale.setTo(0.5,0.5);
			player.animations.add('run');
			player.animations.play('run', 8, true);
			game.physics.enable(player, Phaser.Physics.ARCADE);
			player.body.collideWorldBounds = false;
			player.body.maxVelocity.setTo(MAX_SPEED, MAX_SPEED*10);
			player.body.velocity.x = 100;
			player.body.allowGravity = true;
			player.body.gravity.y = 10000;

			for(var x = 0; x < ground.length; x++){
				ground[x] = game.add.sprite(x*205, game.height - 25, 'rua' );
				game.physics.enable(ground[x], Phaser.Physics.ARCADE);
				ground[x].body.allowGravity = false;
				ground[x].body.immovable = true;
			}

			for(var x = 0; x < ground.length; x++) upAheadQueue.enqueue(ground[x]);
			for(var x = 0; x < background.length; x++) upAheadQueueBackground.enqueue(background[x]);
			churras = game.add.sprite(250, 200, 'chima');
			game.physics.enable(player, Phaser.Physics.ARCADE);
			voice = game.add.audio('churras-voice');
			pontos = game.add.text(320, 10, "0", style);
			pontos.fixedToCamera = true;
			game.camera.follow(player);
			game.camera.deadzone = new Phaser.Rectangle(0,32,25,200);
		}
		
		function update(){
			game.physics.arcade.collide(player, churras, function(){voice.play();});
			for(var x = 0; x < ground.length; x++){
				game.physics.arcade.collide(player, ground[x]);
				game.physics.arcade.collide(churras, ground[x]);
				//ground[x].body.acceleration.x = -ACCELERATION;
				if(!upAheadQueue.peek().inCamera){
					var aux = upAheadQueue.dequeue();
					aux.x = aux.x+(205*8)
					upAheadQueue.enqueue(aux);
					delete aux;
				}
			}

			for(var x = 0; x < background.length; x++){
				if(!upAheadQueueBackground.peek().inCamera){
					var aux = upAheadQueueBackground.dequeue();
					aux.x = aux.x+(622*background.length);
					upAheadQueueBackground.enqueue(aux);
					delete aux;
				}
			}
			if(upInputIsActive()){
				player.body.velocity.y = -800;

			}
			player.body.acceleration.x = ACCELERATION;
			pontos.setText(parseInt(player.x/18) <= 0 ? '0' : parseInt(player.x/18));
		}

		function leftInputIsActive(){
			var isActive = false;

			isActive = game.input.keyboard.isDown(Phaser.Keyboard.LEFT);
			isActive |= (game.input.activePointer.isDown &&
			game.input.activePointer.x < game.width/4);

			return isActive;
		}

		function upInputIsActive(){
			var isActive = false;

			isActive = game.input.keyboard.isDown(Phaser.Keyboard.UP);
			return isActive;
		}

		function rightInputIsActive() {
			var isActive = false;

			isActive = game.input.keyboard.isDown(Phaser.Keyboard.RIGHT);
			isActive |= (game.input.activePointer.isDown &&
			game.input.activePointer.x > game.width/2 + game.width/4);

			return isActive;
		}

		
	</script>
</head>
<body>
<div id="gameCanvas"></div>
</body>
</html>